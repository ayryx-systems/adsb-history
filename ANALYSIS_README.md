# Flight Analysis Layer

Detailed analysis of flights that visited an airport, including distance milestones and timing information.

## Overview

The analysis layer processes flights from the ground aircraft list to create detailed summaries with:
- **Distance milestones**: Time from 100nm, 50nm, and 20nm to touchdown (arrivals)
- **Flight classification**: Arrivals, departures, touch-and-go, and overflights
- **Summary statistics**: Daily counts of each flight type

## Prerequisites

Before running analysis, you must have:
1. **Ground aircraft list**: Generated by `identify-ground-aircraft.js`
   - Stored at: `s3://ayryx-adsb-history/ground-aircraft/AIRPORT/YYYY/MM/DD.json`
2. **Raw trace data**: Available in S3
   - Stored at: `s3://ayryx-adsb-history/raw/YYYY/MM/DD/*.tar`

## Quick Start

### Analyze a single airport/day

```bash
node scripts/analysis/analyze-airport-day.js --airport KLGA --date 2025-11-08
```

### Options

- `--airport ICAO`: Airport ICAO code (required)
- `--date YYYY-MM-DD`: Date to process (required)
- `--force`: Reprocess even if data already exists
- `--help, -h`: Show help message

### Example

```bash
# Analyze KLGA on November 8, 2025
node scripts/analysis/analyze-airport-day.js --airport KLGA --date 2025-11-08

# Force reprocess existing data
node scripts/analysis/analyze-airport-day.js --airport KLGA --date 2025-11-08 --force
```

## Output

Results are saved to S3:
- `s3://ayryx-adsb-history/flight-summaries/AIRPORT/YYYY/MM/DD.json`

Also cached locally at:
- `./cache/AIRPORT/YYYY/MM/summary-DD.json`

### Output Format

```json
{
  "airport": "KLGA",
  "date": "2025-11-08",
  "generatedAt": "2025-11-10T22:58:33.464Z",
  "flights": [
    {
      "icao": "a01097",
      "classification": "arrival",
      "touchdown": {
        "timestamp": 1762612287.79,
        "distance": 0.99,
        "altitude": 375,
        "lat": 40.792053,
        "lon": -73.865295
      },
      "milestones": {
        "timeFrom100nm": 1581.92,
        "timeFrom50nm": 1003.97,
        "timeFrom20nm": 644.33
      },
      "closestApproach": { ... },
      "timeRange": { ... }
    },
    {
      "icao": "a12345",
      "classification": "departure",
      "takeoff": { ... },
      "milestones": {
        "timeTo20nm": 180.5,
        "timeTo50nm": 420.3,
        "timeTo100nm": 890.1
      }
    }
  ],
  "summary": {
    "totalAircraft": 374,
    "arrivals": 185,
    "departures": 180,
    "touchAndGo": 5,
    "overflights": 4,
    "other": 0
  }
}
```

### Milestone Times

- **Arrivals**: `timeFrom100nm`, `timeFrom50nm`, `timeFrom20nm` (seconds from milestone to touchdown)
- **Departures**: `timeTo20nm`, `timeTo50nm`, `timeTo100nm` (seconds from takeoff to milestone)

Times are in seconds. Divide by 60 for minutes.

## How It Works

1. **Load ground aircraft list**: Reads the filtered list of aircraft that were on the ground
2. **Download raw data**: Downloads and extracts the tar file from S3
3. **Analyze flights**: For each aircraft:
   - Parses position reports from trace data
   - Classifies as arrival/departure/touch-and-go/overflight
   - Calculates distance milestones
   - Identifies touchdown/takeoff points
4. **Generate summary**: Creates statistics for the day
5. **Save results**: Stores to S3 and local cache

## Flight Classification

- **Arrival**: High altitude before airport (>5000ft), low altitude near airport (<5000ft), close proximity (<5nm)
- **Departure**: Low altitude near airport (<5000ft), high altitude after airport (>5000ft), close proximity (<5nm)
- **Touch-and-go**: Both arrival and departure patterns detected
- **Overflight**: Passes near airport but doesn't match arrival/departure patterns

## Performance

Processing time depends on:
- Number of aircraft in ground list (~300-400 per day for busy airports)
- Size of trace data (~3GB tar file per day)

Typical processing time: **10-20 minutes** for a single airport/day on a local machine.

## Local vs EC2

Currently designed to run **locally**. For EC2 deployment:
1. Ensure EC2 instance has sufficient disk space (~50GB for extraction)
2. Configure AWS credentials (IAM role or environment variables)
3. Run the same script on EC2

## Troubleshooting

**No ground aircraft found**: Run `identify-ground-aircraft.js` first to generate the ground aircraft list.

**Missing raw data**: Ensure the tar file exists in S3 for the specified date.

**Memory issues**: The script processes traces in a streaming fashion, but extraction requires ~20GB disk space.

