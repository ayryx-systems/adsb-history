<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrival Time Analysis - Flight Planning</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }
        .aircraft-filter {
            flex: 1;
            min-width: 300px;
        }
        .aircraft-filter select {
            width: 100%;
            min-height: 100px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .info h2 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .info-item {
            font-size: 14px;
        }
        .info-item strong {
            color: #555;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .chart-container h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Arrival Time Analysis - Flight Planning</h1>
        
        <div class="controls">
            <div class="control-group">
                <label>Airport</label>
                <select id="airportSelect">
                    <option value="KORD">KORD</option>
                    <option value="KLGA">KLGA</option>
                    <option value="KLAX">KLAX</option>
                    <option value="KSFO">KSFO</option>
                </select>
            </div>
            <div class="control-group">
                <label>Year</label>
                <select id="yearSelect">
                    <option value="2025">2025</option>
                </select>
            </div>
            <div class="control-group">
                <label>Month</label>
                <select id="monthSelect">
                    <option value="01">January</option>
                    <option value="02" selected>February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="control-group">
                <label>Day</label>
                <select id="daySelect">
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05" selected>05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                </select>
            </div>
            <div class="control-group aircraft-filter">
                <label>Aircraft Types (Select to Filter)</label>
                <select id="aircraftTypeSelect" multiple size="5">
                </select>
                <small style="color: #666; margin-top: 5px;">Hold Ctrl/Cmd to select multiple</small>
            </div>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="loadingMessage" class="loading" style="display: none;">Loading data...</div>
        
        <div id="infoSection" class="info" style="display: none;">
            <h2 id="infoTitle"></h2>
            <div class="info-grid" id="infoGrid"></div>
        </div>

        <div id="chartsSection" style="display: none;">
            <div class="chart-container">
                <h3>Arrival Counts by Time Slot</h3>
                <div class="chart-wrapper">
                    <canvas id="arrivalCountChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>Time from 50nm by Time Slot</h3>
                <div class="chart-wrapper">
                    <canvas id="time50nmChart"></canvas>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(75, 192, 192, 0.6);"></div>
                        <span>Median (p50)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(54, 162, 235, 0.4);"></div>
                        <span>p75</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 206, 86, 0.4);"></div>
                        <span>p90</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 99, 132, 0.4);"></div>
                        <span>p95</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(201, 203, 207, 0.6);"></div>
                        <span>Max</span>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Time from 100nm by Time Slot</h3>
                <div class="chart-wrapper">
                    <canvas id="time100nmChart"></canvas>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(153, 102, 255, 0.6);"></div>
                        <span>Median (p50)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(75, 192, 192, 0.4);"></div>
                        <span>p75</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 206, 86, 0.4);"></div>
                        <span>p90</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 99, 132, 0.4);"></div>
                        <span>p95</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(201, 203, 207, 0.6);"></div>
                        <span>Max</span>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Arrival Time Distribution by Aircraft Type</h3>
                <div class="chart-wrapper">
                    <canvas id="aircraftTypeTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentData = null;
        let selectedAircraftTypes = [];

        function getDataPath() {
            const airport = document.getElementById('airportSelect').value;
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            const day = document.getElementById('daySelect').value;
            return `cache/${airport}/${year}/${month}/l1-stats-${day}.json`;
        }

        async function loadData() {
            const path = getDataPath();
            const errorDiv = document.getElementById('errorMessage');
            const loadingDiv = document.getElementById('loadingMessage');
            const chartsSection = document.getElementById('chartsSection');
            const infoSection = document.getElementById('infoSection');

            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            chartsSection.style.display = 'none';
            infoSection.style.display = 'none';

            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`Failed to load: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                currentData = data;
                
                loadingDiv.style.display = 'none';
                displayInfo(data);
                populateAircraftTypes(data);
                renderCharts(data);
                chartsSection.style.display = 'block';
                infoSection.style.display = 'block';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = `Error loading data: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        function displayInfo(data) {
            document.getElementById('infoTitle').textContent = 
                `${data.airport} - ${data.date}`;
            
            const grid = document.getElementById('infoGrid');
            grid.innerHTML = `
                <div class="info-item"><strong>Total Arrivals:</strong> ${data.totalArrivals.toLocaleString()}</div>
                <div class="info-item"><strong>Aircraft Types:</strong> ${Object.keys(data.byAircraftType).length}</div>
                <div class="info-item"><strong>Generated:</strong> ${new Date(data.generatedAt).toLocaleString()}</div>
            `;
        }

        function populateAircraftTypes(data) {
            const select = document.getElementById('aircraftTypeSelect');
            const types = Object.keys(data.byAircraftType)
                .sort((a, b) => data.byAircraftType[b].count - data.byAircraftType[a].count);
            
            select.innerHTML = types.map(type => {
                const count = data.byAircraftType[type].count;
                return `<option value="${type}">${type} (${count} arrivals)</option>`;
            }).join('');
        }

        function getSelectedAircraftTypes() {
            const select = document.getElementById('aircraftTypeSelect');
            return Array.from(select.selectedOptions).map(opt => opt.value);
        }

        function calculatePercentile(sortedArray, percentile) {
            if (sortedArray.length === 0) return null;
            const index = Math.ceil((percentile / 100) * sortedArray.length) - 1;
            return sortedArray[Math.max(0, Math.min(index, sortedArray.length - 1))];
        }

        function calculateStats(times) {
            if (times.length === 0) {
                return {
                    median: null,
                    p75: null,
                    p90: null,
                    p95: null,
                    p99: null,
                    max: null
                };
            }

            const sorted = [...times].sort((a, b) => a - b);
            return {
                median: calculatePercentile(sorted, 50),
                p75: calculatePercentile(sorted, 75),
                p90: calculatePercentile(sorted, 90),
                p95: calculatePercentile(sorted, 95),
                p99: calculatePercentile(sorted, 99),
                max: sorted[sorted.length - 1]
            };
        }

        function filterTimeSlotData(timeSlot, selectedTypes) {
            if (!selectedTypes || selectedTypes.length === 0) {
                return timeSlot;
            }

            const filteredAircraft = timeSlot.aircraft.filter(ac => 
                selectedTypes.includes(ac.type)
            );

            if (filteredAircraft.length === 0) {
                return null;
            }

            const times100nm = filteredAircraft
                .map(ac => ac.milestones?.timeFrom100nm)
                .filter(t => t !== undefined);
            
            const times50nm = filteredAircraft
                .map(ac => ac.milestones?.timeFrom50nm)
                .filter(t => t !== undefined);

            return {
                count: filteredAircraft.length,
                stats100nm: calculateStats(times100nm),
                stats50nm: calculateStats(times50nm)
            };
        }

        function getTimeSlotStats(timeSlot, milestone, selectedTypes) {
            if (selectedTypes.length === 0) {
                const aircraft = timeSlot.aircraft || [];
                const times = aircraft
                    .map(ac => ac.milestones?.[milestone])
                    .filter(t => t !== undefined);
                return calculateStats(times);
            } else {
                const filtered = filterTimeSlotData(timeSlot, selectedTypes);
                if (!filtered) return calculateStats([]);
                return milestone === 'timeFrom100nm' ? filtered.stats100nm : filtered.stats50nm;
            }
        }

        function destroyChart(chartId) {
            if (charts[chartId]) {
                charts[chartId].destroy();
                delete charts[chartId];
            }
        }

        function renderCharts(data) {
            destroyChart('arrivalCount');
            destroyChart('time100nm');
            destroyChart('time50nm');
            destroyChart('aircraftTypeTime');

            const selectedTypes = getSelectedAircraftTypes();
            renderArrivalCountChart(data, selectedTypes);
            renderTime100nmChart(data, selectedTypes);
            renderTime50nmChart(data, selectedTypes);
            renderAircraftTypeTimeChart(data, selectedTypes);
        }

        function renderArrivalCountChart(data, selectedTypes) {
            const timeSlots = data.overall.byTouchdownTimeSlot;
            const slots = Object.keys(timeSlots).sort();
            
            const counts = slots.map(slot => {
                if (selectedTypes.length === 0) {
                    return timeSlots[slot].count;
                }
                const filtered = filterTimeSlotData(timeSlots[slot], selectedTypes);
                return filtered ? filtered.count : 0;
            });

            charts['arrivalCount'] = new Chart(document.getElementById('arrivalCountChart'), {
                type: 'bar',
                data: {
                    labels: slots,
                    datasets: [{
                        label: 'Arrivals',
                        data: counts,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderTime100nmChart(data, selectedTypes) {
            const timeSlots = data.overall.byTouchdownTimeSlot;
            const slots = Object.keys(timeSlots).sort();
            
            const medians = [];
            const p75s = [];
            const p90s = [];
            const p95s = [];
            const maxs = [];

            slots.forEach(slot => {
                const stats = getTimeSlotStats(timeSlots[slot], 'timeFrom100nm', selectedTypes);
                medians.push(stats.median ? stats.median / 60 : null);
                p75s.push(stats.p75 ? stats.p75 / 60 : null);
                p90s.push(stats.p90 ? stats.p90 / 60 : null);
                p95s.push(stats.p95 ? stats.p95 / 60 : null);
                maxs.push(stats.max ? stats.max / 60 : null);
            });

            charts['time100nm'] = new Chart(document.getElementById('time100nmChart'), {
                type: 'line',
                data: {
                    labels: slots,
                    datasets: [{
                        label: 'Median (p50)',
                        data: medians,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1,
                        pointRadius: 2,
                        borderWidth: 2
                    }, {
                        label: 'p75',
                        data: p75s,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        pointRadius: 1,
                        borderWidth: 1,
                        borderDash: [5, 5]
                    }, {
                        label: 'p90',
                        data: p90s,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.1,
                        pointRadius: 1,
                        borderWidth: 1,
                        borderDash: [5, 5]
                    }, {
                        label: 'p95',
                        data: p95s,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        pointRadius: 1,
                        borderWidth: 1,
                        borderDash: [5, 5]
                    }, {
                        label: 'Max',
                        data: maxs,
                        borderColor: 'rgba(201, 203, 207, 1)',
                        backgroundColor: 'rgba(201, 203, 207, 0.1)',
                        tension: 0.1,
                        pointRadius: 2,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Time (minutes)' }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderTime50nmChart(data, selectedTypes) {
            const timeSlots = data.overall.byTouchdownTimeSlot;
            const slots = Object.keys(timeSlots).sort();
            
            const medians = [];
            const p75s = [];
            const p90s = [];
            const p95s = [];
            const maxs = [];

            slots.forEach(slot => {
                const stats = getTimeSlotStats(timeSlots[slot], 'timeFrom50nm', selectedTypes);
                medians.push(stats.median ? stats.median / 60 : null);
                p75s.push(stats.p75 ? stats.p75 / 60 : null);
                p90s.push(stats.p90 ? stats.p90 / 60 : null);
                p95s.push(stats.p95 ? stats.p95 / 60 : null);
                maxs.push(stats.max ? stats.max / 60 : null);
            });

            charts['time50nm'] = new Chart(document.getElementById('time50nmChart'), {
                type: 'line',
                data: {
                    labels: slots,
                    datasets: [{
                        label: 'Median (p50)',
                        data: medians,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 2,
                        borderWidth: 2
                    }, {
                        label: 'p75',
                        data: p75s,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        pointRadius: 1,
                        borderWidth: 1,
                        borderDash: [5, 5]
                    }, {
                        label: 'p90',
                        data: p90s,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.1,
                        pointRadius: 1,
                        borderWidth: 1,
                        borderDash: [5, 5]
                    }, {
                        label: 'p95',
                        data: p95s,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        pointRadius: 1,
                        borderWidth: 1,
                        borderDash: [5, 5]
                    }, {
                        label: 'Max',
                        data: maxs,
                        borderColor: 'rgba(201, 203, 207, 1)',
                        backgroundColor: 'rgba(201, 203, 207, 0.1)',
                        tension: 0.1,
                        pointRadius: 2,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Time (minutes)' }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }


        function renderAircraftTypeTimeChart(data, selectedTypes) {
            const types = selectedTypes.length > 0 
                ? selectedTypes 
                : Object.keys(data.byAircraftType)
                    .sort((a, b) => data.byAircraftType[b].count - data.byAircraftType[a].count)
                    .slice(0, 10);

            const datasets = [];
            const colors = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(201, 203, 207, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)'
            ];

            types.forEach((type, idx) => {
                if (!data.byAircraftType[type]) return;
                
                const milestone = data.byAircraftType[type].milestones.timeFrom50nm;
                if (!milestone) return;

                const timeSlots = data.overall.byTouchdownTimeSlot;
                const slots = Object.keys(timeSlots).sort();
                
                const medians = slots.map(slot => {
                    const slotData = timeSlots[slot];
                    const aircraft = slotData.aircraft.filter(ac => ac.type === type);
                    if (aircraft.length === 0) return null;
                    
                    const times = aircraft
                        .map(ac => ac.milestones?.timeFrom50nm)
                        .filter(t => t !== undefined);
                    
                    if (times.length === 0) return null;
                    return times.sort((a, b) => a - b)[Math.floor(times.length / 2)] / 60;
                });

                datasets.push({
                    label: `${type} (${data.byAircraftType[type].count})`,
                    data: medians,
                    borderColor: colors[idx % colors.length].replace('0.6', '1'),
                    backgroundColor: colors[idx % colors.length],
                    tension: 0.1,
                    pointRadius: 2
                });
            });

            charts['aircraftTypeTime'] = new Chart(document.getElementById('aircraftTypeTimeChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(data.overall.byTouchdownTimeSlot).sort(),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Time from 50nm (minutes)' }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('airportSelect').addEventListener('change', loadData);
        document.getElementById('yearSelect').addEventListener('change', loadData);
        document.getElementById('monthSelect').addEventListener('change', loadData);
        document.getElementById('daySelect').addEventListener('change', loadData);
        document.getElementById('aircraftTypeSelect').addEventListener('change', () => {
            if (currentData) {
                renderCharts(currentData);
            }
        });

        loadData();
    </script>
</body>
</html>
